<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Similarity Search - Gemini API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .image-card.active {
            border: 4px solid #10b981;
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <div class="max-w-4xl mx-auto p-4">
        <!-- Header -->
        <header class="text-center py-6">
            <h1 class="text-3xl font-bold text-gray-800">Gemini Visual Search</h1>
            <p class="text-gray-600">Busca imágenes similares usando IA multimodal</p>
        </header>

        <!-- API Key Config (Para pruebas rápidas) -->
        <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
            <label class="block text-sm font-medium text-gray-700">Gemini API KEY:</label>
            <input type="password" id="apiKey" placeholder="Pega tu API Key aquí" 
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <!-- Secciones Principales -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Panel Lateral: Consulta -->
            <div class="md:col-span-1 space-y-6">
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <h2 class="text-lg font-semibold mb-4">Imagen de Consulta</h2>
                    
                    <div id="queryPreviewContainer" class="hidden mb-4">
                        <img id="queryPreview" class="w-full h-48 object-cover rounded-lg border-2 border-blue-500">
                        <p class="text-xs text-gray-500 mt-1 text-center">Buscando similares a esta...</p>
                    </div>

                    <div class="space-y-3">
                        <label class="block w-full text-center px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition">
                            Subir Nueva Consulta
                            <input type="file" id="queryInput" class="hidden" accept="image/*">
                        </label>
                        <button id="searchBtn" disabled class="w-full px-4 py-2 bg-green-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            Analizar Similitud
                        </button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <h2 class="text-lg font-semibold mb-2">Instrucciones</h2>
                    <ul class="text-sm text-gray-600 list-disc ml-4 space-y-1">
                        <li>Sube varias fotos a la galería.</li>
                        <li>Sube una foto de consulta o haz clic en una de la galería.</li>
                        <li>Gemini ordenará la galería por parecido visual.</li>
                    </ul>
                </div>
            </div>

            <!-- Panel Principal: Galería -->
            <div class="md:col-span-2">
                <div class="bg-white p-4 rounded-xl shadow-sm min-h-[400px]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Galería (<span id="count">0</span>)</h2>
                        <label class="text-sm text-blue-600 cursor-pointer font-medium hover:underline">
                            + Añadir Imágenes
                            <input type="file" id="galleryInput" class="hidden" multiple accept="image/*">
                        </label>
                    </div>

                    <!-- Grid de Imágenes -->
                    <div id="galleryGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <!-- Imágenes se insertan aquí -->
                    </div>

                    <!-- Estado Vacío -->
                    <div id="emptyState" class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <p>No hay imágenes en la galería</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay de Carga -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden flex flex-col items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <p class="text-white font-medium">Gemini analizando imágenes...</p>
    </div>

    <script>
        // CONFIGURACIÓN
        // Reemplaza 'YOUR_API_KEY_HERE' por tu llave o usa el input de la UI
        let GEMINI_API_KEY = "YOUR_API_KEY_HERE";
        const MODEL_NAME = "gemini-1.5-flash"; 

        // ESTADO DE LA APP
        let galleryImages = []; // Array de { id, file, url, score }
        let currentQueryFile = null;

        // ELEMENTOS DOM
        const galleryInput = document.getElementById('galleryInput');
        const queryInput = document.getElementById('queryInput');
        const galleryGrid = document.getElementById('galleryGrid');
        const queryPreview = document.getElementById('queryPreview');
        const queryPreviewContainer = document.getElementById('queryPreviewContainer');
        const searchBtn = document.getElementById('searchBtn');
        const emptyState = document.getElementById('emptyState');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const apiKeyInput = document.getElementById('apiKey');

        // EVENTOS
        galleryInput.addEventListener('change', handleGalleryUpload);
        queryInput.addEventListener('change', (e) => handleQuerySelection(e.target.files[0]));
        searchBtn.addEventListener('click', performSimilaritySearch);

        // FUNCIONES DE CARGA Y RENDER
        function handleGalleryUpload(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const id = Math.random().toString(36).substr(2, 9);
                galleryImages.push({
                    id: id,
                    file: file,
                    url: URL.createObjectURL(file),
                    score: null
                });
            });
            renderGallery();
        }

        function handleQuerySelection(file) {
            if (!file) return;
            currentQueryFile = file;
            queryPreview.src = URL.createObjectURL(file);
            queryPreviewContainer.classList.remove('hidden');
            searchBtn.disabled = false;
        }

        function useFromGalleryAsQuery(id) {
            const imgObj = galleryImages.find(img => img.id === id);
            if (imgObj) {
                // Para usar de la galería como consulta, necesitamos el file original
                handleQuerySelection(imgObj.file);
                // Marcar visualmente en la galería
                renderGallery(id);
            }
        }

        function renderGallery(activeId = null) {
            galleryGrid.innerHTML = '';
            document.getElementById('count').innerText = galleryImages.length;
            
            if (galleryImages.length > 0) {
                emptyState.classList.add('hidden');
            }

            galleryImages.forEach((img) => {
                const div = document.createElement('div');
                div.className = `image-card relative bg-white rounded-lg overflow-hidden shadow cursor-pointer transition-all ${activeId === img.id ? 'active' : ''}`;
                div.onclick = () => useFromGalleryAsQuery(img.id);

                let scoreBadge = '';
                if (img.score !== null) {
                    const pct = Math.round(img.score * 100);
                    scoreBadge = `<div class="absolute top-1 right-1 bg-green-500 text-white text-[10px] px-1.5 py-0.5 rounded shadow-md font-bold">${pct}% Similitud</div>`;
                }

                div.innerHTML = `
                    <img src="${img.url}" class="w-full h-32 object-cover">
                    ${scoreBadge}
                `;
                galleryGrid.appendChild(div);
            });
        }

        // LÓGICA DE API GEMINI
        async function fileToGenerativePart(file) {
            const base64Promise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inline_data: {
                    data: await base64Promise,
                    mime_type: file.type
                }
            };
        }

        async function performSimilaritySearch() {
            const apiKey = apiKeyInput.value || GEMINI_API_KEY;
            if (!apiKey || apiKey === "YOUR_API_KEY_HERE") {
                alert("Por favor, introduce una API Key válida de Gemini.");
                return;
            }

            if (galleryImages.length === 0) {
                alert("Sube algunas imágenes a la galería primero.");
                return;
            }

            loadingOverlay.classList.remove('hidden');

            try {
                // Preparar la Query Image
                const queryPart = await fileToGenerativePart(currentQueryFile);
                
                // Preparar las Candidate Images (limitar a las primeras 15 por estabilidad del prompt)
                const candidatesToProcess = galleryImages.slice(0, 15);
                const candidateParts = await Promise.all(
                    candidatesToProcess.map(img => fileToGenerativePart(img.file))
                );

                const prompt = `You are an image similarity engine. 
                The first image is the QUERY. The following images are CANDIDATES. 
                Compare each CANDIDATE with the QUERY and calculate a visual similarity score between 0.0 (nothing alike) and 1.0 (identical or very similar).
                Focus on colors, shapes, objects and composition.
                Return ONLY a JSON array of objects where each object has:
                {"index": number, "score": number}. 
                The index refers to the position in the candidates list starting at 0.`;

                // Construcción del payload
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            queryPart, // Imagen 0 del array de contenido (pero marcada como query en texto)
                            ...candidateParts
                        ]
                    }],
                    generationConfig: {
                        response_mime_type: "application/json"
                    }
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                const responseText = data.candidates[0].content.parts[0].text;
                const scores = JSON.parse(responseText.replace(/```json|```/g, ""));

                // Mapear scores de vuelta a nuestro estado
                scores.forEach(item => {
                    if (candidatesToProcess[item.index]) {
                        candidatesToProcess[item.index].score = item.score;
                    }
                });

                // Ordenar: Mayores scores primero
                galleryImages.sort((a, b) => (b.score || 0) - (a.score || 0));

                renderGallery();

            } catch (error) {
                console.error(error);
                alert("Error al contactar con Gemini: " + error.message);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
